<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<title>Scheine-Scanner</title>
<style>
:root {
	font-family: sans;
	font-size: 4em;
	background-color: #eee;
}
#layout {
	margin-top: 1em;
	width: 100%;
	overflow: clip;
	display: flex;
	flex-flow: column nowrap;
	align-items: stretch;
}
#layout > * {
	margin-top: .5em;
}
video {
	border: 4vw solid grey;
	background-color: grey;
}
#button-pane {
	display: grid;
	gap: 1em;
	grid-template-columns: auto auto;
}
button {
	padding: .5rem;
}
#logger {
	border: thin solid black;
	font-family: monospace;
	padding: .3rem;
}
#logger th {
	text-align: left;
}
#results-pane {
	display: flex;
}
#db-info {
	margin-right: auto;
	min-width: 1em;
	font-family: monospace;
	border: thin solid black;
	padding: .3rem;
}
#cam-qr-result {
	font-family: monospace;
	border: thin solid black;
	padding: .3em;
}
</style>
<style>
#video-container {
	line-height: 0;
}
video.status-false {
	border-color: tomato !important;
}
video.status-true {
	border-color: lime !important;
}
#video-container.example-style-1 .scan-region-highlight-svg,
#video-container.example-style-1 .code-outline-highlight {
	stroke: #64a2f3 !important;
}
#video-container.example-style-2 {
	position: relative;
	width: max-content;
	height: max-content;
	overflow: hidden;
}
#video-container.example-style-2 .scan-region-highlight {
	border-radius: 30px;
	outline: rgba(0, 0, 0, .25) solid 50vmax;
}
#video-container.example-style-2 .scan-region-highlight-svg {
	display: none;
}
#video-container.example-style-2 .code-outline-highlight {
	stroke: rgba(255, 255, 255, .5) !important;
	stroke-width: 15px !important;
	stroke-dasharray: none !important;
}
</style>
</head>
<body>
<div id="layout">
	<!--<div id="button-pane">
		<button id="start-button">Start</button>
		<button id="stop-button">Stop</button>
	</div>-->
	<div id="video-container">
		<video id="qr-video"></video>
	</div>
	<div id="results-pane">
		<div id="db-info"></div>
		<div id="cam-qr-result"></div>
	</div>
	<!--<pre id="debug-output"></pre>-->
	<table id="logger">
	<thead>
		<tr>
			<th>#</th>
			<th>Code</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
	</table>
</div>

<!--<script src="../qr-scanner.umd.min.js"></script>-->
<!--<script src="../qr-scanner.legacy.min.js"></script>-->
<script src="vendor/nimiq/qr-scanner.umd.min.js"></script>
<script>
//~ console.log(QrScanner);

//~ function trace(text) {
//~ 	const e = document.getElementById("debug-output");
//~ 	e.textContent += String(text) + "\n";
//~ }
//~ console.log = trace;
//~ console.warn = trace;

const video = document.getElementById('qr-video');
const videoContainer = document.getElementById('video-container');
const camQrResult = document.getElementById('cam-qr-result');
const logger = document.getElementById("logger");
const dbinfo = document.getElementById("db-info");

if (!("scheinescanner" in localStorage))
	localStorage["scheinescanner"] = JSON.stringify([]);

function addCodeToLocalStorage(text) {
	const s = JSON.parse(localStorage["scheinescanner"]);
	s.push(text);
	localStorage["scheinescanner"] = JSON.stringify(s);
}

function sendCodeToDatabaseServer(code) {
	fetch("http://springer.sportsontheweb.net/api.php?code=" + code)
	.then(response => response.json())
	.then(json => {
		setDbInfoFromDbResult(json);
		log(json.count, code);
	});
}

function log(count, code) {
//~ 	logger.textContent += String(text) + "\n";

//~ 	const p = document.createElement("div");
//~ 	p.textContent = text;
//~ 	logger.appendChild(p);

	const td0 = document.createElement("td");
	td0.textContent = count;

	const td1 = document.createElement("td");
	td1.textContent = code;

	const tr = document.createElement("tr");
	tr.appendChild(td0);
	tr.appendChild(td1);

	const tbody = logger.children[1];
//~ 	tbody.appendChild(tr);
	tbody.insertBefore(tr, tbody.firstChild);
}

let statusTimer = undefined;
function setStatus(ok, delay = 500) {
	if (statusTimer) clearTimeout(statusTimer);
	video.classList.remove(ok ? "status-false" : "status-true");
	video.classList.add(ok ? "status-true" : "status-false");
	statusTimer = setTimeout(() => {
		video.classList.remove(ok ? "status-true" : "status-false");
	}, delay);
}

function parseCodeFromUrl(text) {
	const m = text.match(/https?:\/\/vereinsschein-qr\.rewe\.de\/\?code=R-(.+)/);
	return m ? m[1] : text;
}
//~ setTimeout(() => console.log(parseCodeFromUrl("https://vereinsschein-qr.rewe.de/?code=R-12345678910")), 200);

function setDbInfoFromDbResult(json) {
	dbinfo.textContent = json.count;
	dbinfo.classList.remove("status-true");
	dbinfo.classList.remove("status-false");
	dbinfo.classList.add(json.status ? "status-true" : "status-false");
}

let lastResult = undefined;
function setResult(label, result) {
	if (lastResult === result.data) return;
	lastResult = result.data;
//~ 	trace(label, result.data);
	label.textContent = result.data;
	label.style.color = 'teal';
	clearTimeout(label.highlightTimeout);
	label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);

	setStatus(true);
	const code = parseCodeFromUrl(result.data);
	sendCodeToDatabaseServer(code);
//~ 	addCodeToLocalStorage(code);
}

const scanner = new QrScanner(
	video,
	result => setResult(camQrResult, result),
	{
		onDecodeError: error => {
			camQrResult.textContent = "Nichts gefunden."; // error;
			camQrResult.style.color = 'inherit';
//~ 			trace("onDecodeError", error);
			setStatus(false);
		},
		highlightScanRegion: true,
		highlightCodeOutline: true,
	}
);
//~ window.scanner = scanner; // for debugging

scanner.start().then(() => {
	scanner.setCamera("environment"); // environment, user
});

// default-style, example-style-1, example-style-2
videoContainer.className = "example-style-2";
scanner._updateOverlay();

scanner.$canvas.style.display = "block"; // block, none
scanner.setInversionMode("original"); ; // original, invert, both

//~ document.getElementById('start-button').addEventListener('click', () => {
//~ 	scanner.start();
//~ 	pulse();
//~ });
//~ document.getElementById('stop-button').addEventListener('click', () => {
//~ 	scanner.stop();
//~ });
</script>
</body>
</html>